<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Detalles de Cotización</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        .section { margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; margin-top: 5px; }
        label { display: inline-block; margin-bottom: 5px; }
        button { padding: 10px 20px; margin-top: 20px; }
    </style>

    <script>
        // Función para mostrar u ocultar áreas de texto
        function toggleTextarea(checkboxId, textareaId) {
            const checkbox = document.getElementById(checkboxId);
            const textarea = document.getElementById(textareaId);
            textarea.disabled = !checkbox.checked;
            textarea.style.display = checkbox.checked ? "block" : "none";
        }

        window.onload = function() {
            // Llamamos una vez al cargar la página para aplicar el estado inicial
            toggleTextarea("add_requirements", "manual_requirements");
            toggleTextarea("add_sh", "manual_items_sh");
            toggleTextarea("add_detection", "manual_items_detection");
            toggleTextarea("add_protection", "manual_items_protection");
        };
    </script>
</head>

<body>
<h1>Detalles de Cotización</h1>

<form method="POST" action="{% url 'quote_details' quote.id %}">
    {% csrf_token %}

    <div class="section">
        <h2>Cliente: {{ quote.client.full_name }}</h2>
        <p><strong>Proyecto:</strong> {{ quote.project_name }}</p>
    </div>

    <hr>

    <div class="section">
        <h3>Requerimientos adicionales del cliente</h3>
        <input type="checkbox" id="add_requirements" onclick="toggleTextarea('add_requirements','manual_requirements')">
        <label for="add_requirements">Agregar requerimientos manualmente</label><br>
        <textarea id="manual_requirements" name="manual_requirements" placeholder="Escribe aquí los requerimientos adicionales..." disabled></textarea>
    </div>

    {% if quote.is_human_safety %}
    <div class="section">
        <h3>Seguridad Humana</h3>
        <input type="checkbox" id="add_sh" onclick="toggleTextarea('add_sh','manual_items_sh')">
        <label for="add_sh">Agregar ítems manualmente (Seguridad Humana)</label><br>
        <textarea id="manual_items_sh" name="manual_items_sh" placeholder="Escribe aquí los ítems adicionales de Seguridad Humana..." disabled></textarea>
        <br>
    </div>
    {% endif %}

    {% if quote.is_detection %}
    <div class="section">
        <h3>Detección de incendios</h3>
        <input type="checkbox" id="add_detection" onclick="toggleTextarea('add_detection','manual_items_detection')">
        <label for="add_detection">Agregar ítems manualmente (Detección de incendios)</label><br>
        <textarea id="manual_items_detection" name="manual_items_detection" placeholder="Escribe aquí los ítems adicionales de Detección..." disabled></textarea>
        <br>
    </div>
    {% endif %}

    {% if quote.is_protection %}
    <div class="section">
        <h3>Protección contra incendios</h3>
        <input type="checkbox" id="add_protection" onclick="toggleTextarea('add_protection','manual_items_protection')">
        <label for="add_protection">Agregar ítems manualmente (Protección)</label><br>
        <textarea id="manual_items_protection" name="manual_items_protection" placeholder="Escribe aquí los ítems adicionales de Protección..." disabled></textarea>
        <br>
    </div>
    {% endif %}

    <div class="section">
        <h3>Formatos de entrega</h3>
        <input type="checkbox" name="deliver_autocad" id="deliver_autocad" {% if quote.deliver_autocad %}checked{% endif %}>
        <label for="deliver_autocad">Autocad</label>
        <input type="checkbox" name="deliver_revit" id="deliver_revit" {% if quote.deliver_revit %}checked{% endif %}>
        <label for="deliver_revit">Revit</label>
    </div>
    <hr>

    <div class="section">
        <h3>Forma de pago</h3>
        <label>Anticipo (%):</label>
        <input type="number" name="payment_advance" value="{{ quote.payment_advance }}"><br><br>

        <label>Primera versión (%):</label>
        <input type="number" name="payment_first_version" value="{{ quote.payment_first_version }}"><br><br>

        <label>Entrega final (%):</label>
        <input type="number" name="payment_final" value="{{ quote.payment_final }}">
    </div>

    <div class="section">
        <h3>Tiempo de entrega</h3>
        <label>Duración:</label>
        <input type="number" name="delivery_time_value" value="{{ quote.delivery_time_value }}" min="1">
        <select name="delivery_time_unit">
            <option value="days" {% if quote.delivery_time_unit == "days" %}selected{% endif %}>Días</option>
            <option value="weeks" {% if quote.delivery_time_unit == "weeks" %}selected{% endif %}>Semanas</option>
            <option value="months" {% if quote.delivery_time_unit == "months" %}selected{% endif %}>Meses</option>
        </select>
    </div>

    <div class="section">
        <h3>Notas adicionales</h3>
        <label for="notes_count">Cantidad de notas:</label>
        <select id="notes_count" name="notes_count" onchange="updateNotes(this.value)">
            <option value="0">0</option>
            {% for i in notes_range %}
            <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
        </select>

        <div id="notes_container"></div>

        <script>
            function updateNotes(count) {
                const container = document.getElementById("notes_container");
                container.innerHTML = "";
                for (let i = 1; i <= count; i++) {
                    container.innerHTML += `<label>Nota ${i}:</label><br><textarea name="note_${i}" placeholder="Escribe aquí la nota ${i}..."></textarea><br>`;
                }
            }
        </script>
    </div>

    <div class="section">
        <h3>Normas aplicables</h3>
        {% for norm in norms %}
            <label>
                <input type="checkbox" name="selected_norms" value="{{ norm.id }}"
                {% if norm in quote.norms.all %}checked{% endif %}>
                {{ norm.code }} — {{ norm.description }}
            </label><br>
        {% endfor %}
    </div>

    <!-- Selección de servicios reales (para backend) -->
    <input type="hidden" name="is_detection" value="{{ quote.is_detection|yesno:'true,false' }}">
    <input type="hidden" name="is_protection" value="{{ quote.is_protection|yesno:'true,false' }}">
    <input type="hidden" name="is_human_safety" value="{{ quote.is_human_safety|yesno:'true,false' }}">

    <!-- Selección de formatos reales -->
    <input type="hidden" name="deliver_autocad" value="{{ quote.deliver_autocad|yesno:'true,false' }}">
    <input type="hidden" name="deliver_revit" value="{{ quote.deliver_revit|yesno:'true,false' }}">


    <button type="submit">Generar Documento Final</button>
</form>

</body>
</html>
